<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Number Memory Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the game board */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        .game-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
            max-width: 500px;
            width: 100%;
            aspect-ratio: 1 / 1; /* Keep it square */
            margin: 0 auto;
            padding: 10px;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            background: linear-gradient(145deg, #161b22, #0d1117);
        }
        .tile {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            background-color: #23272e;
            border-radius: 0.5rem;
            cursor: pointer;
            /* Default transitions (will be overridden in JS for fade duration) */
            transition: transform 0.1s ease, background-color 0.2s, box-shadow 0.2s;
            user-select: none;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4), 0 1px 3px rgba(0, 0, 0, 0.2);
            position: relative; /* For nested span */
        }
        
        /* The span that holds the number, which will fade */
        .number-content {
            /* Opacity transition duration will be set dynamically in JS */
            transition: opacity 2s ease-in-out; 
            opacity: 0; /* Initially hidden */
            color: #c9d1d9;
        }

        .tile.active-number {
            background-color: #30475e; /* Darker blue background */
        }
        .tile.active-number .number-content {
            opacity: 1; /* Fully visible */
            color: #ffffff;
        }

        /* State during the recall phase (after fading) - Opacity 0 for complete disappearance */
        .tile.recall-phase .number-content {
            opacity: 0; 
            color: #c9d1d9;
        }

        /* State on correct click */
        .tile.clicked-correctly {
            background-color: #38a169; /* Green for correct */
            box-shadow: 0 0 15px rgba(56, 161, 105, 0.8);
        }
        .tile.clicked-correctly .number-content {
            opacity: 1; 
            color: #0d1117; /* Dark text for contrast on green background */
        }
        
        /* State on incorrect click */
        .tile.clicked-incorrectly {
            background-color: #e53e3e; /* Red for incorrect */
            animation: shake 0.5s;
        }
        .tile.clicked-incorrectly .number-content {
            opacity: 1; 
            color: #ffffff;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .button {
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
        }
        .button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase access
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = null;

        // Set Firestore log level to Debug
        setLogLevel('Debug');

        const initializeFirebase = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                window.appId = appId;
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                const authPromise = new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(window.auth, async (user) => {
                        unsubscribe(); // Stop listening after the first event
                        if (user) {
                            window.userId = user.uid;
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(window.auth, initialAuthToken);
                                window.userId = window.auth.currentUser.uid;
                            } else {
                                const anonymousUser = await signInAnonymously(window.auth);
                                window.userId = anonymousUser.user.uid;
                            }
                        }
                        console.log("Firebase Auth Ready. User ID:", window.userId);
                        resolve();
                    });
                });

                await authPromise;
                window.checkHighestScore(); // Now safe to call after auth is ready
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        };

        // Expose function to global scope
        window.initializeFirebase = initializeFirebase;

    </script>
</head>
<body class="p-4 flex flex-col items-center min-h-screen">

    <div class="text-center mb-6">
        <h1 class="text-4xl font-bold text-blue-400 mb-2">Number Recall Challenge</h1>
        <p id="status-message" class="text-xl text-gray-300">Prepare to begin!</p>
        <div class="mt-4 flex flex-wrap justify-center gap-4">
            <span id="level-display" class="px-4 py-2 bg-purple-600 rounded-full text-white font-semibold shadow-lg">Level: 0</span>
            <span id="target-display" class="px-4 py-2 bg-yellow-600 rounded-full text-white font-semibold shadow-lg">Next: 1</span>
            <span id="highest-score-display" class="px-4 py-2 bg-gray-700 rounded-full text-white font-semibold shadow-lg">Highest Level: 0</span>
            <span id="recall-timer" class="px-4 py-2 bg-red-600 rounded-full text-white font-semibold shadow-lg hidden">Time: 10.0s</span>
        </div>
    </div>

    <div id="game-container" class="game-grid mb-6">
        </div>

    <button id="start-button" onclick="startGame()" class="button bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full text-lg">
        Start Game
    </button>
    
    <div id="game-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50 p-4" onclick="hideModal()">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full" onclick="event.stopPropagation()">
            <h2 id="modal-title" class="text-3xl font-bold mb-4 text-white"></h2>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <button id="modal-action-button" class="button bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full">
                Action Button
            </button>
        </div>
    </div>

    <script>
        // --- Game Constants ---
        const GRID_SIZE = 25; // 5x5 grid
        const MAX_NUMBER = 25;
        const RECALL_TIME_LIMIT_SECONDS = 10; 
        
        // WIN_GOAL_LEVEL is set to 10 from the previous modification
        const WIN_GOAL_LEVEL = 10; 
        
        // Fixed Speed Settings (Time Decrement is 0, so speed is constant)
        // MODIFIED: FADE DURATION set to 1250ms
        const INITIAL_FADE_DURATION_MS = 1250; 
        // MODIFIED: MEMORIZATION TIME set to 1750ms
        const INITIAL_MEMORIZATION_TIME_MS = 1750; 
        const TIME_DECREMENT_PER_LEVEL_MS = 0; 
        const MIN_MEMORIZATION_TIME_MS = 500; 
        const MIN_FADE_DURATION_MS = 300; 
        
        // Dynamic time variables (will be updated in startGame)
        let FADE_DURATION_MS = INITIAL_FADE_DURATION_MS;
        let MEMORIZATION_TIME_MS = INITIAL_MEMORIZATION_TIME_MS;
        
        // --- Game State ---
        let state = {
            level: 0,
            currentNumberCount: 0,
            targetNumber: 1,
            isRecallPhase: false,
            numbersOnGrid: [], 
            numberPositions: new Map(), 
            highestLevel: 0,
            isGameRunning: false
        };

        // --- Timer State ---
        let recallTimerId = null;

        // --- DOM Elements ---
        const gameContainer = document.getElementById('game-container');
        const startButton = document.getElementById('start-button');
        const statusMessage = document.getElementById('status-message');
        const levelDisplay = document.getElementById('level-display');
        const targetDisplay = document.getElementById('target-display');
        const highestScoreDisplay = document.getElementById('highest-score-display');
        const gameModal = document.getElementById('game-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalActionButton = document.getElementById('modal-action-button'); 
        const recallTimerDisplay = document.getElementById('recall-timer');

        // --- Firebase/Data Functions ---

        window.saveHighestScore = async () => {
            if (!window.db || !window.userId || !window.appId || state.level <= state.highestLevel) return;

            try {
                const docRef = doc(window.db, `artifacts/${window.appId}/users/${window.userId}/memory_game_scores`, 'high_score');
                await setDoc(docRef, { 
                    highestLevel: state.level,
                    timestamp: new Date() 
                }, { merge: true });

                state.highestLevel = state.level;
                updateUI();
            } catch (error) {
                console.error("Error saving high score:", error);
            }
        };

        window.checkHighestScore = async () => {
            if (!window.db || !window.userId || !window.appId) return;

            try {
                const docRef = doc(window.db, `artifacts/${window.appId}/users/${window.userId}/memory_game_scores`, 'high_score');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    state.highestLevel = docSnap.data().highestLevel || 0;
                    updateUI();
                }
            } catch (error) {
                console.error("Error checking high score:", error);
            }
        };


        // --- Utility Functions ---

        /**
         * Generates unique random positions for the numbers.
         */
        const generateNumberPositions = (count) => {
            const positions = new Set();
            while (positions.size < count) {
                positions.add(Math.floor(Math.random() * GRID_SIZE));
            }
            
            const newNumbersOnGrid = [];
            const newNumberPositions = new Map();
            let i = 1;
            for (const pos of positions) {
                newNumbersOnGrid.push({ positionIndex: pos, numberValue: i });
                newNumberPositions.set(i, pos);
                i++;
            }
            state.numbersOnGrid = newNumbersOnGrid;
            state.numberPositions = newNumberPositions;
        };

        /**
         * Renders the game grid (5x5 tiles), creating a nested span for the number content.
         */
        const renderGameGrid = () => {
            gameContainer.innerHTML = '';
            for (let i = 0; i < GRID_SIZE; i++) {
                const tile = document.createElement('div');
                tile.id = `tile-${i}`;
                tile.className = 'tile';
                tile.dataset.index = i;
                tile.onclick = handleTileClick;
                
                // Add a span for the number content which will handle the fading opacity
                const numberSpan = document.createElement('span');
                numberSpan.className = 'number-content';
                numberSpan.id = `num-span-${i}`;
                tile.appendChild(numberSpan);

                gameContainer.appendChild(tile);
            }
        };

        /**
         * Updates the display elements.
         */
        const updateUI = () => {
            levelDisplay.textContent = `Level: ${state.level}`;
            targetDisplay.textContent = `Next: ${state.targetNumber}`;
            highestScoreDisplay.textContent = `Highest Level: ${state.highestLevel}`;
            startButton.disabled = state.isGameRunning;
            startButton.textContent = state.isGameRunning ? 'In Progress...' : 'Start Game';
        };

        /**
         * Hides the game modal.
         */
        const hideModal = () => {
            gameModal.classList.add('hidden');
        };

        /**
         * Shows the game over or level complete modal with a dynamic button.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message body.
         * @param {string} buttonText - The text for the action button.
         * @param {function} actionFunction - The function to call when the button is clicked.
         */
        const showModal = (title, message, buttonText, actionFunction) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalActionButton.textContent = buttonText;
            
            // Remove previous onclick handler
            modalActionButton.onclick = null;
            
            // Set new handler that hides the modal and then performs the action
            modalActionButton.onclick = () => {
                hideModal();
                actionFunction();
            };

            gameModal.classList.remove('hidden');
        };

        /**
         * Resets the game state and UI to start fresh.
         */
        const resetGame = () => {
            clearRecallTimer();
            state.level = 0;
            state.currentNumberCount = 0;
            state.targetNumber = 1;
            state.isRecallPhase = false;
            state.numbersOnGrid = [];
            state.numberPositions = new Map();
            state.isGameRunning = false;
            statusMessage.textContent = 'Ready to start the challenge!';
            
            // Reset tile appearances
            document.querySelectorAll('.tile').forEach(tile => {
                const numberSpan = tile.querySelector('.number-content');
                // Reset custom transition
                tile.style.transition = '';
                numberSpan.style.transition = '';
                
                tile.className = 'tile';
                numberSpan.textContent = '';
                tile.onclick = handleTileClick; 
            });

            updateUI();
        };

        // --- Timer Functions ---

        const clearRecallTimer = () => {
            if (recallTimerId) {
                clearInterval(recallTimerId);
                recallTimerId = null;
            }
            recallTimerDisplay.classList.add('hidden');
        };

        const handleTimeOut = () => {
             // If a timeout occurs, and we are still in recall phase, it's game over
            if (state.isRecallPhase) {
                state.isRecallPhase = false;
                state.isGameRunning = false;
                
                // Show where the correct number was (same as incorrect click)
                const correctPosition = state.numberPositions.get(state.targetNumber);
                const correctTile = document.getElementById(`tile-${correctPosition}`);
                if (correctTile) {
                    correctTile.classList.remove('recall-phase');
                    correctTile.classList.add('clicked-incorrectly');
                    correctTile.querySelector('.number-content').textContent = state.targetNumber;
                }

                statusMessage.textContent = `TIME OUT! Level ${state.level} Failed.`;
                
                // Game Over Modal Action: Start Level 1 again
                showModal(
                    'TIME OUT!', 
                    `You ran out of time to find number ${state.targetNumber}. You reached Level ${state.level}.`,
                    'Play Again',
                    () => { resetGame(); startGame(); } // Reset then start fresh
                );
            }
        };

        const startRecallTimer = () => {
            clearRecallTimer(); // Clear any existing timer
            
            let timeRemaining = RECALL_TIME_LIMIT_SECONDS;
            recallTimerDisplay.textContent = `Time: ${timeRemaining.toFixed(1)}s`;
            recallTimerDisplay.classList.remove('hidden', 'bg-red-800');
            recallTimerDisplay.classList.add('bg-red-600');

            // The clock starts counting down
            recallTimerId = setInterval(() => {
                // Use 100ms interval for smoother display
                timeRemaining -= 0.1; 
                
                if (timeRemaining <= 0) {
                    clearRecallTimer();
                    handleTimeOut();
                } else {
                    recallTimerDisplay.textContent = `Time: ${Math.max(0, timeRemaining).toFixed(1)}s`;
                    if (timeRemaining <= 3) {
                        recallTimerDisplay.classList.remove('bg-red-600');
                        recallTimerDisplay.classList.add('bg-red-800'); // More urgent color
                    }
                }
            }, 100); // Update every 100ms for smooth countdown
        };

        // --- Game Phases ---

        /**
         * Starts the game or moves to the next level.
         */
        const startGame = () => {
            // Check state.isGameRunning is false to ensure we don't double-start.
            // When transitioning between levels, we set state.isGameRunning to false before calling startGame.
            if (state.isGameRunning) return; 
            clearRecallTimer();

            state.isGameRunning = true;
            state.level++;
            
            // 1. Calculate number count: Start at 1, increase by 1 each level.
            state.currentNumberCount = Math.min(MAX_NUMBER, state.level);
            state.targetNumber = 1;

            // 2. Adjust Hardness (Time Reduction)
            const levelFactor = state.level - 1;
            const timeReduction = levelFactor * TIME_DECREMENT_PER_LEVEL_MS;
            
            // These remain constant since TIME_DECREMENT_PER_LEVEL_MS is 0
            MEMORIZATION_TIME_MS = Math.max(MIN_MEMORIZATION_TIME_MS, INITIAL_MEMORIZATION_TIME_MS - timeReduction);
            FADE_DURATION_MS = Math.max(MIN_FADE_DURATION_MS, INITIAL_FADE_DURATION_MS - timeReduction);


            // 3. Update UI and start
            const numberText = state.currentNumberCount > 1 ? 'numbers' : 'number';
            // Show the user the fixed memorization time in the status message
            statusMessage.textContent = `Level ${state.level}: Memorize ${state.currentNumberCount} ${numberText} in ${(MEMORIZATION_TIME_MS + FADE_DURATION_MS)/1000} seconds!`;
            updateUI();

            // Ensure we don't try to generate 0 numbers if level somehow reset oddly
            if (state.currentNumberCount > 0) {
                generateNumberPositions(state.currentNumberCount);
                startMemorizationPhase();
            } else {
                // Should only happen if level is 0, which is handled by state.level++
                console.error("Attempted to start game with 0 numbers.");
                resetGame();
            }
        };

        /**
         * Displays numbers for memorization and sets the fade timer.
         */
        const startMemorizationPhase = () => {
            state.isRecallPhase = false;
            const transitionDurationStyle = `${FADE_DURATION_MS}ms`;

            // Clear all previous markings and content
            document.querySelectorAll('.tile').forEach(tile => {
                const numberSpan = tile.querySelector('.number-content');
                tile.className = 'tile';
                numberSpan.textContent = '';
                
                // Re-enable click handler for ALL tiles for the new round
                tile.onclick = handleTileClick; 
                
                // Set the transition duration on both elements for simultaneous fade
                tile.style.transition = `transform 0.1s ease, background-color ${transitionDurationStyle} ease-in-out, box-shadow 0.2s`;
                numberSpan.style.transition = `opacity ${transitionDurationStyle} ease-in-out, color 0.2s`; 
            });

            // Display current numbers
            state.numbersOnGrid.forEach(item => {
                const tile = document.getElementById(`tile-${item.positionIndex}`);
                if (tile) {
                    const numberSpan = tile.querySelector('.number-content');
                    numberSpan.textContent = item.numberValue;
                    tile.classList.add('active-number');
                }
            });

            // Timer 1: End of Memorization Time -> Start Fade
            setTimeout(() => {
                // FADE START: This triggers the background color and number opacity transition
                document.querySelectorAll('.tile.active-number').forEach(tile => {
                    tile.classList.remove('active-number');
                    tile.classList.add('recall-phase');
                });
            }, MEMORIZATION_TIME_MS);

            // Timer 2: End of Fade Time -> Start Recall Phase (and start the timer)
            setTimeout(startRecallPhase, MEMORIZATION_TIME_MS + FADE_DURATION_MS);
        };

        /**
         * Begins the recall phase where the user clicks the numbers in order.
         * The recall timer is started here, after the fade has completed.
         */
        const startRecallPhase = () => {
            state.isRecallPhase = true;
            statusMessage.textContent = `Recall Phase: Click ${state.targetNumber} next.`;
            updateUI();
            
            // Start the 10-second timer now that the numbers are fully invisible
            startRecallTimer();
        };

        /**
         * Handles the user clicking a tile during the recall phase.
         */
        window.handleTileClick = (event) => {
            if (!state.isRecallPhase) return;

            const clickedTile = event.currentTarget;
            const clickedIndex = parseInt(clickedTile.dataset.index);

            // Check if the clicked location matches the target number's position
            const correctPosition = state.numberPositions.get(state.targetNumber);
            const clickedNumberSpan = clickedTile.querySelector('.number-content');

            if (clickedIndex === correctPosition) {
                // CORRECT CLICK
                clickedTile.classList.remove('recall-phase');
                clickedTile.classList.add('clicked-correctly');
                clickedNumberSpan.textContent = state.targetNumber; // Ensure number is visible again
                clickedTile.onclick = null; // Disable further clicks on this tile

                state.targetNumber++;

                if (state.targetNumber > state.currentNumberCount) {
                    // LEVEL WON
                    clearRecallTimer();
                    state.isRecallPhase = false;
                    state.isGameRunning = false;
                    window.saveHighestScore();

                    // Check if the current level is the final challenge level
                    if (state.level >= WIN_GOAL_LEVEL) {
                        // VICTORY ACHIEVED (GOAL MET)
                        statusMessage.textContent = `CHALLENGE COMPLETE! You beat the game!`;
                        // Updated the win message to reflect the ${WIN_GOAL_LEVEL}-number goal
                        showModal(
                            'CHALLENGE COMPLETE!', 
                            `You successfully completed the ${WIN_GOAL_LEVEL}-number challenge!`,
                            'Start New Game',
                            resetGame 
                        );
                    } 
                    else { 
                        // INSTANT TRANSITION TO NEXT LEVEL (with a tiny visual delay)
                        statusMessage.textContent = `LEVEL ${state.level} COMPLETE! Starting next round...`;
                        
                        // Use a small delay (500ms) to ensure the "COMPLETE!" message is visible before the grid refreshes.
                        setTimeout(() => {
                            // state.isGameRunning is already false, so startGame will proceed.
                            startGame();
                        }, 500); 
                    }
                } else {
                    // Continue to next number - Reset the timer!
                    startRecallTimer();
                    statusMessage.textContent = `Correct! Now click ${state.targetNumber}.`;
                    updateUI();
                }

            } else {
                // INCORRECT CLICK - GAME OVER
                clearRecallTimer();
                state.isRecallPhase = false;
                state.isGameRunning = false;
                
                // Show where the correct number was
                const correctPosition = state.numberPositions.get(state.targetNumber);
                const correctTile = document.getElementById(`tile-${correctPosition}`);
                if (correctTile) {
                    correctTile.classList.remove('recall-phase');
                    correctTile.classList.add('clicked-incorrectly');
                    correctTile.querySelector('.number-content').textContent = state.targetNumber;
                }
                
                // Mark the incorrect click
                clickedTile.classList.add('clicked-incorrectly');

                statusMessage.textContent = `GAME OVER! Level ${state.level} Failed.`;
                
                // Game Over Modal Action: Start Level 1 again
                showModal(
                    'GAME OVER!', 
                    `You failed to find number ${state.targetNumber}. You reached Level ${state.level}.`,
                    'Play Again',
                    () => { resetGame(); startGame(); } // Reset state then immediately call startGame
                );
            }
        };
        
        // Expose startGame to the global scope for the button's onclick attribute
        window.startGame = startGame;
        // Expose hideModal to the global scope for the modal's onclick attribute
        window.hideModal = hideModal;


        // --- Initialization ---

        window.onload = () => {
            renderGameGrid();
            resetGame();
            window.initializeFirebase(); // Initialize Firebase on load
        };
    </script>
</body>
</html>